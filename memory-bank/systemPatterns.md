# SWARM — Архитектура и паттерны

## Общая архитектура

### Модель коммуникации
Вся межпроцессная коммуникация происходит через SQLite:
- Нет сокетов, пайпов, разделяемой памяти или брокеров сообщений
- Каждый процесс (CLI Лидера, CLI агента, монитор) читает/пишет в один файл БД
- WAL-режим для параллельного чтения при одном писателе

### Три логических роли
1. **Терминал Лидера** — управление, создание задач, мониторинг
2. **Терминалы агентов** — LLM-агенты в YOLO-режиме
3. **Терминал монитора** — live-дашборд

## Ключевые паттерны

### Алгоритм распределения задач (Цепочка фильтров)
```
1. Проверка зависимостей (depends_on)
2. Фильтр по роли (жёсткий) — target_role
3. Фильтр по имени (жёсткий) — target_name
4. Фильтр по типу CLI (жёсткий) — target_cli
5. Сортировка по приоритету, затем по task_id
```

### Механизм блокировки файлов
- UNIQUE constraint на file_path для атомарного захвата
- Поллинг каждые 3 секунды при ожидании
- Алфавитный порядок захвата для предотвращения дедлоков
- Автоматическое снятие при `swarm done`

### Жизненный цикл агента
```
НЕ_ЗАРЕГИСТРИРОВАН → (swarm join) → IDLE
IDLE → (swarm next + задача) → WORKING
WORKING → (swarm lock блокирован) → WAITING
WAITING → (файл освобождён) → WORKING
WORKING → (swarm done) → IDLE
```

### Жизненный цикл задачи
```
pending → (swarm next) → in_progress → (swarm done) → done
pending → (зависимость не готова) → blocked → (зависимость готова) → pending
```

## Соглашения по коду
- Комментарии на русском языке
- Type hints для всех функций
- Dataclass для моделей данных
- Атомарные транзакции с BEGIN IMMEDIATE
